## Introduction
This lab will go through some basic on how to do memory forensic and malware reverse engineering.

## Volatility lab 01 - Redline(CyberDefender)
In this lab we will be using lab from cyberdefender you can download the lab from the following link -> https://cyberdefenders.org/blueteam-ctf-challenges/redline/.
You need to register to the platform in order to able to download the sample file. Once you get the .zip file you can unzip it and enter the password, like this:

```
~# unzip 106-RedLine.zip 
Archive:  106-RedLine.zip
[106-RedLine.zip] temp_extract_dir/MemoryDump.mem password: 
  inflating: temp_extract_dir/MemoryDump.mem  
                                             
```
We can test volatility to check which Windows OS does this memory dump come from:
```
~# python3 vol.py -f ~/Desktop/temp_extract_dir/MemoryDump.mem windows.info 
Volatility 3 Framework 2.26.0
Progress:    0.10               Reading file http://msdl.microsoft.com/download/....
```
When you run the program first time it will automatically download the neccessary PDB to be used to parse all related information to interact with of the OS inside the dump. If its done it will show you the following result:
```
Variable        Value

Kernel Base     0xf8076221a000
DTB     0x1ad000
Symbols file:///home/kali/Documents/volatility/volatility3-2.26.0/volatility3/symbols/windows/ntkrnlmp.pdb/68A17FAF3012B7846079AEECDBE0A583-1.json.xz
Is64Bit True
IsPAE   False
layer_name      0 WindowsIntel32e
memory_layer    1 FileLayer
KdVersionBlock  0xf80762e29398
Major/Minor     15.19041
MachineType     34404
KeNumberProcessors      4
SystemTime      2023-05-21 23:02:39+00:00
NtSystemRoot    C:\Windows
NtProductType   NtProductWinNt
NtMajorVersion  10
NtMinorVersion  0
PE MajorOperatingSystemVersion  10
PE MinorOperatingSystemVersion  0
PE Machine      34404
PE TimeDateStamp        Wed Jun 28 04:14:26 1995
```
I'm not gonna answer the question that showed in cyberdefenders dashboard, but I will explain certain question that you should answer first when you work as a forensic investigator or incident responder.

1. The first or the most obvious will be where is the malware?

The most straightforward will be using the windows.malfind plugin from volatility, like this:
```
~# python3 vol.py -f ~/Desktop/temp_extract_dir/MemoryDump.mem  windows.malfind
Volatility 3 Framework 2.5.0
Progress:  100.00               PDB scanning finished                        
PID     Process Start VPN       End VPN Tag     Protection      CommitCharge    PrivateMemory   File output     Hexdump Disasm

5896    oneetx.exe      0x400000        0x437fff        VadS    PAGE_EXECUTE_READWRITE  56      1       Disabled
4d 5a 90 00 03 00 00 00 MZ......
04 00 00 00 ff ff 00 00 ........
b8 00 00 00 00 00 00 00 ........
40 00 00 00 00 00 00 00 @.......
00 00 00 00 00 00 00 00 ........
00 00 00 00 00 00 00 00 ........
00 00 00 00 00 00 00 00 ........
00 00 00 00 00 01 00 00 ........


7540    smartscreen.ex  0x2505c140000   0x2505c15ffff   VadS    PAGE_EXECUTE_READWRITE  1       1       Disabled
48 89 54 24 10 48 89 4c H.T$.H.L
24 08 4c 89 44 24 18 4c $.L.D$.L
89 4c 24 20 48 8b 41 28 .L$.H.A(
48 8b 48 08 48 8b 51 50 H.H.H.QP
48 83 e2 f8 48 8b ca 48 H...H..H
b8 60 00 14 5c 50 02 00 .`..\P..
00 48 2b c8 48 81 f9 70 .H+.H..p
0f 00 00 76 09 48 c7 c1 ...v.H..
0x2505c140000:  mov     qword ptr [rsp + 0x10], rdx
0x2505c140005:  mov     qword ptr [rsp + 8], rcx
0x2505c14000a:  mov     qword ptr [rsp + 0x18], r8
0x2505c14000f:  mov     qword ptr [rsp + 0x20], r9
0x2505c140014:  mov     rax, qword ptr [rcx + 0x28]
0x2505c140018:  mov     rcx, qword ptr [rax + 8]
0x2505c14001c:  mov     rdx, qword ptr [rcx + 0x50]
0x2505c140020:  and     rdx, 0xfffffffffffffff8
0x2505c140024:  mov     rcx, rdx
0x2505c140027:  movabs  rax, 0x2505c140060
0x2505c140031:  sub     rcx, rax
0x2505c140034:  cmp     rcx, 0xf70
0x2505c14003b:  jbe     0x2505c140046
```
Windows.malfind plugin will be search inside the entire the memory dump to find any signature that matched with its malware database and as you can see we got two matches which are the first the malware itself, while the second is smartscreen.exe file and if you try to investigate what is that program.

You will end up windows defender page, so basically SmartScreen is a cloud-based anti-phishing/anti-malware component which is included in different Microsoft products such as: Windows, Internet Explorer and Microsoft Edge. But why is it marked as malware by the plugin?

My answer is that this could be view as the disadvantages of detecting malware through signature. To emphasize this statement, I would like to ask you guys a very simple question, can you tell the difference between a Teamviewer and Remote Access Trojan?

You might tempted to answer one is malware and one is not, if you answer that you're missing the nature of the question. How can you tell if one is malicious and one is not? if i remove the name both of the program can you guess which one is which?

If you try to reverse engineer it you might end up in the same conclusion both of the program may have the same functionality and both of them allow to do remote connection.

To actually measured if a program is malicious we have to know the "intention" of the program. But solely rely on code signature would not cut it and it could lead to false positive.
 
